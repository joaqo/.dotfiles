#!/bin/bash
# pk - interactive process killer using fzf

# Parse args
ALL=false
[[ "$1" == "--all" || "$1" == "-a" ]] && ALL=true

# Build ps command: PID, CPU, MEM, START, ARGS (full command for searching)
if $ALL; then
  PS_CMD="ps ax -o pid,pcpu,pmem,start,args"
else
  PS_CMD="ps x -o pid,pcpu,pmem,start,args"
fi

# Format: fixed-width columns, args at end gets naturally clipped
colorize() {
  awk 'NR==1 {printf "\033[1;37m%7s %5s %5s %8s  %-20s %s\033[0m\n", "PID", "%CPU", "%MEM", "START", "NAME", "COMMAND"; next}
  {
    pid=$1; cpu=$2; mem=$3; start=$4
    # Extract basename
    n = split($5, parts, "/")
    name = parts[n]
    # Full args (fields 5+)
    args=""
    for(i=5;i<=NF;i++) args = args $i " "
    printf "\033[36m%7s\033[0m \033[33m%5s %5s\033[0m \033[37m%8s\033[0m  \033[97m%-20s\033[0m \033[90m%s\033[0m\n", pid, cpu, mem, start, name, args
  }'
}

# Preview script
PREVIEW='
  pid={1}
  info=$(ps -p $pid -o user,%cpu,%mem,start,command 2>/dev/null | tail -1)
  user=$(echo "$info" | awk "{print \$1}")
  cpu=$(echo "$info" | awk "{print \$2}")
  mem=$(echo "$info" | awk "{print \$3}")
  start=$(echo "$info" | awk "{print \$4}")
  cmd=$(echo "$info" | awk "{for(i=5;i<=NF;i++) printf \"%s \", \$i; print \"\"}")

  echo -e "\033[1;36mPID\033[0m"
  echo "$pid"
  echo ""
  echo -e "\033[1;36mUser\033[0m"
  echo "$user"
  echo ""
  echo -e "\033[1;36mCPU %\033[0m"
  echo "$cpu"
  echo ""
  echo -e "\033[1;36mMemory %\033[0m"
  echo "$mem"
  echo ""
  echo -e "\033[1;36mStarted\033[0m"
  echo "$start"
  echo ""
  echo -e "\033[1;36mCommand\033[0m"
  echo "$cmd"
  echo ""
  echo -e "\033[1;36mOpen Ports\033[0m"
  lsof -i -P -n 2>/dev/null | grep "^[^ ]*[ ]*$pid " | awk "{print \$9}" || echo "None"
'

# Run fzf
selected=$($PS_CMD | colorize | \
  fzf --ansi \
      --multi \
      --layout=reverse \
      --height=40% \
      --no-hscroll \
      --header="enter: kill | ctrl-k: force kill | tab: multi-select" \
      --expect=ctrl-k \
      --preview="$PREVIEW" \
      --preview-window=right:40%:wrap \
      --header-lines=1)

# Parse output
key=$(echo "$selected" | head -1)
pids=$(echo "$selected" | tail -n +2 | awk '{print $1}')

[[ -z "$pids" ]] && exit 0

# Kill with appropriate signal
if [[ "$key" == "ctrl-k" ]]; then
  echo "$pids" | xargs kill -9
  echo "Force killed: $pids"
else
  echo "$pids" | xargs kill
  echo "Killed: $pids"
fi
