#!/bin/bash
cd "$(git rev-parse --show-toplevel)" || exit 1

if git diff --staged --quiet; then
  echo "Nothing staged. Staging all changes..."
  git add --all
  if git diff --staged --quiet; then
    echo "No changes to commit." >&2
    exit 1
  fi
fi

PROMPT='Generate a concise git commit message for these staged changes. Output ONLY the raw commit message with no markdown, no code blocks, no backticks, no explanations, no co-authored-by lines, no attribution. Use conventional commit format.'

echo "Generating commit message..."
git diff --staged | claude -p --no-session-persistence "$PROMPT" --model haiku --output-format text 2>/dev/null > /tmp/commit_msg
git commit -e -F /tmp/commit_msg
